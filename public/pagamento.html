<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Pagamento - RESTART</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="pagamento.css">
</head>

<body>
    <div class="payment-container">
        <h1>Pagamento - InscriÃ§Ã£o RESTART</h1>
        <p id="aviso"> VALOR 15,00</p>

        <div id="loading">Gerando Pix... <div class="spinner"></div>
        </div>

        <div id="qrCode">
            <img id="qrImg" src="" alt="QR Code">
            <p>CÃ³digo Copia e Cola:</p>
            <textarea id="pixCode" rows="3" readonly></textarea>
            <button id="btnCopiar">Copiar Pix</button>
        </div>

        <div id="status"></div>
    </div>

    <script>
        async function gerarPix() {
            const formData = localStorage.getItem('formData');
            const usuario = formData ? JSON.parse(formData) : null;

            if (!usuario || !usuario.nome || !usuario.email || !usuario.cpf) {
                alert("Erro: dados do formulÃ¡rio nÃ£o encontrados. Volte e preencha novamente.");
                document.getElementById("loading").textContent = "Erro: dados nÃ£o encontrados.";
                return;
            }

            try {
                const resp = await fetch("http://localhost:3001/generate-pix", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(usuario)
                });

                const data = await resp.json();

                if (resp.status !== 200 || !data.qr_code_base64) {
                    console.error("Erro Mercado Pago:", data);
                    alert("Erro ao gerar Pix. Veja console do servidor.");
                    document.getElementById("loading").textContent = "Erro ao gerar Pix.";
                    return;
                }

                document.getElementById("loading").style.display = "none";
                document.getElementById("qrCode").style.display = "block";
                document.getElementById("qrImg").src = "data:image/png;base64," + data.qr_code_base64;
                document.getElementById("pixCode").value = data.qr_code;

                verificarPagamento(data.id, usuario);

            } catch (err) {
                console.error(err);
                document.getElementById("loading").textContent = "Erro ao gerar Pix.";
            }
        }

        async function verificarPagamento(payment_id, usuario) {
            const interval = setInterval(async () => {
                try {
                    const resp = await fetch(`http://localhost:3001/check-status/${payment_id}`);
                    const data = await resp.json();

                    if (data.status === "approved") {
                        clearInterval(interval);
                        document.getElementById("status").textContent = "ðŸŸ© InscriÃ§Ã£o realizada com sucesso!";

                        await fetch("http://localhost:3001/send-to-sheet", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(usuario)
                        });

                        localStorage.removeItem('formData');

                    } else {
                        document.getElementById("status").textContent = `Aguardando pagamento... (${data.status})`;
                    }
                } catch (err) {
                    console.error(err);
                }
            }, 3000);
        }

        document.getElementById("btnCopiar").addEventListener("click", () => {
            const pixCode = document.getElementById("pixCode");
            pixCode.select();
            pixCode.setSelectionRange(0, 99999);
            try {
                document.execCommand("copy");
                alert("Pix copiado para a Ã¡rea de transferÃªncia!");
            } catch (err) {
                console.error("Erro ao copiar:", err);
            }
        });

        gerarPix();
    </script>
</body>

</html>