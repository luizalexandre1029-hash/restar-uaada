<!-- <!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Pagamento - RESTART</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/pagamento.css">
</head>

<body>
    <div class="payment-container">
        <h1>Pagamento - Inscri칞칚o RESTART</h1>
        <p id="aviso">VALOR R$10,00</p>

        <div id="loading">Gerando Pix... <div class="spinner"></div>
        </div>

        <div id="qrCode" style="display:none;">
            <img id="qrImg" src="" alt="QR Code">
            <p>C칩digo Copia e Cola:</p>
            <textarea id="pixCode" rows="3" readonly></textarea>
            <button id="btnCopiar">Copiar Pix</button>
        </div>

        <div id="status"></div>
    </div>

    <script>
        async function gerarPix() {
            const formData = localStorage.getItem('formData');
            const usuario = formData ? JSON.parse(formData) : null;

            if (!usuario || !usuario.nome || !usuario.email || !usuario.cpf) {
                alert("Erro: dados do formul치rio n칚o encontrados. Volte e preencha novamente.");
                document.getElementById("loading").textContent = "Erro: dados n칚o encontrados.";
                document.getElementById("loading").style.display = "block";
                return;
            }

            document.getElementById("loading").style.display = "block";

            try {
                const resp = await fetch("/api/generate-pix", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(usuario)
                });

                const data = await resp.json();

                if (!resp.ok) {
                    if (data.error) {
                        document.getElementById("loading").style.display = "none";
                        alert(data.error);
                        document.getElementById("status").textContent = data.error;
                    }
                    return;
                }

                document.getElementById("aviso").textContent = `VALOR R$10,00 - Vagas restantes: ${data.vagasRestantes}`;
                document.getElementById("loading").style.display = "none";
                document.getElementById("qrCode").style.display = "block";
                document.getElementById("qrImg").src = "data:image/png;base64," + data.qr_code_base64;
                document.getElementById("pixCode").value = data.qr_code;

                verificarPagamento(data.id, usuario);

            } catch (err) {
                console.error(err);
                document.getElementById("loading").textContent = "Erro ao gerar Pix.";
            }
        }

        async function verificarPagamento(payment_id, usuario) {
            const interval = setInterval(async () => {
                try {
                    const resp = await fetch(`/api/check-status/${payment_id}`);
                    const data = await resp.json();

                    if (data.status === "approved") {
                        clearInterval(interval);
                        document.getElementById("status").textContent = "游릴 Inscri칞칚o realizada com sucesso!";

                        await fetch("/api/send-to-sheet", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(usuario)
                        });

                        localStorage.removeItem('formData');
                    } else {
                        document.getElementById("status").textContent = `Aguardando pagamento... (${data.status})`;
                    }
                } catch (err) {
                    console.error(err);
                    document.getElementById("status").textContent = "Erro ao verificar pagamento.";
                }
            }, 3000);
        }

        document.getElementById("btnCopiar").addEventListener("click", () => {
            const pixCode = document.getElementById("pixCode");
            pixCode.select();
            pixCode.setSelectionRange(0, 99999);
            try {
                document.execCommand("copy");
                alert("Pix copiado para a 치rea de transfer칡ncia!");
            } catch (err) {
                console.error("Erro ao copiar:", err);
            }
        });

        gerarPix();
    </script>
</body>

</html> -->



<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Pagamento - RESTART</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/pagamento.css">
    <style>
        #confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: gold;
            opacity: 0.8;
            animation: fall 3s linear infinite;
        }

        @keyframes fall {
            0% {
                transform: translateY(-10px) rotate(0deg);
            }

            100% {
                transform: translateY(100vh) rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="payment-container">
        <h1>Pagamento - Inscri칞칚o RESTART</h1>
        <p id="aviso">VALOR R$10,00</p>

        <div id="loading">Gerando Pix... <div class="spinner"></div>
        </div>

        <div id="qrCode" style="display:none;">
            <img id="qrImg" src="" alt="QR Code">
            <p>C칩digo Copia e Cola:</p>
            <textarea id="pixCode" rows="3" readonly></textarea>
            <button id="btnCopiar">Copiar Pix</button>
        </div>

        <div id="status"></div>
    </div>

    <div id="confetti"></div>

    <script>
        function criarConfete() {
            const confettiContainer = document.getElementById("confetti");
            for (let i = 0; i < 100; i++) {
                const div = document.createElement("div");
                div.classList.add("confetti-piece");
                div.style.left = Math.random() * window.innerWidth + "px";
                div.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                div.style.animationDelay = Math.random() * 3 + "s";
                div.style.animationDuration = 2 + Math.random() * 3 + "s";
                confettiContainer.appendChild(div);
            }
        }

        async function gerarPix() {
            const formData = localStorage.getItem('formData');
            const usuario = formData ? JSON.parse(formData) : null;

            if (!usuario || !usuario.nome || !usuario.email || !usuario.cpf) {
                alert("Erro: dados do formul치rio n칚o encontrados. Volte e preencha novamente.");
                document.getElementById("loading").textContent = "Erro: dados n칚o encontrados.";
                document.getElementById("loading").style.display = "block";
                return;
            }

            console.log("Usuario carregado do localStorage:", usuario);

            document.getElementById("loading").style.display = "block";

            try {
                const resp = await fetch("/api/generate-pix", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(usuario)
                });

                const data = await resp.json();

                if (!resp.ok) {
                    if (data.error) {
                        document.getElementById("loading").style.display = "none";
                        alert(data.error);
                        document.getElementById("status").textContent = data.error;
                    }
                    return;
                }

                document.getElementById("aviso").textContent = `VALOR R$10,00 - Vagas restantes: ${data.vagasRestantes}`;
                document.getElementById("loading").style.display = "none";
                document.getElementById("qrCode").style.display = "block";
                document.getElementById("qrImg").src = "data:image/png;base64," + data.qr_code_base64;
                document.getElementById("pixCode").value = data.qr_code;

                verificarPagamento(data.id, usuario);

            } catch (err) {
                console.error(err);
                document.getElementById("loading").textContent = "Erro ao gerar Pix.";
            }
        }

        async function verificarPagamento(payment_id, usuario) {
            const interval = setInterval(async () => {
                try {
                    const resp = await fetch(`/api/check-status/${payment_id}`);
                    const data = await resp.json();

                    if (data.status === "approved") {
                        clearInterval(interval);

                        // Mostrar mensagem e confete
                        const statusDiv = document.getElementById("status");
                        statusDiv.innerHTML = `
                            游릴 Pagamento aprovado!<br>
                            九괦잺 Email de confirma칞칚o enviado!
                        `;
                        statusDiv.classList.add("show");
                        criarConfete();

                        // Enviar para Google Sheets e enviar email
                        await fetch("/api/send-to-sheet", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(usuario)
                        });

                        localStorage.removeItem('formData');
                    } else {
                        document.getElementById("status").textContent = `Aguardando pagamento... (${data.status})`;
                    }
                } catch (err) {
                    console.error(err);
                    document.getElementById("status").textContent = "Erro ao verificar pagamento.";
                }
            }, 3000);
        }

        document.getElementById("btnCopiar").addEventListener("click", () => {
            const pixCode = document.getElementById("pixCode");
            pixCode.select();
            pixCode.setSelectionRange(0, 99999);
            try {
                document.execCommand("copy");
                alert("Pix copiado para a 치rea de transfer칡ncia!");
            } catch (err) {
                console.error("Erro ao copiar:", err);
            }
        });

        gerarPix();
    </script>
</body>

</html>