<!-- <!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Pagamento - RESTART</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/pagamento.css">
</head>

<body>
    <div class="payment-container">
        <h1>Pagamento - Inscri√ß√£o RESTART</h1>
        <p id="aviso">VALOR R$10,00</p>

        <div id="loading">Gerando Pix... <div class="spinner"></div>
        </div>

        <div id="qrCode">
            <img id="qrImg" src="" alt="QR Code">
            <p>C√≥digo Copia e Cola:</p>
            <textarea id="pixCode" rows="3" readonly></textarea>
            <button id="btnCopiar">Copiar Pix</button>
        </div>

        <div id="status"></div>
    </div>

    <script>
        async function gerarPix() {
            const formData = localStorage.getItem('formData');
            const usuario = formData ? JSON.parse(formData) : null;

            if (!usuario || !usuario.nome || !usuario.email || !usuario.cpf) {
                alert("Erro: dados do formul√°rio n√£o encontrados. Volte e preencha novamente.");
                document.getElementById("loading").textContent = "Erro: dados n√£o encontrados.";
                document.getElementById("loading").style.display = "block";
                return;
            }

            document.getElementById("loading").style.display = "block";

            try {
                const resp = await fetch("/api/generate-pix", {  // <- ajustado para /api
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(usuario)
                });

                if (!resp.ok) {
                    const errorData = await resp.json().catch(() => ({}));
                    console.error("Erro Mercado Pago:", errorData);
                    document.getElementById("loading").textContent = "Erro ao gerar Pix.";
                    return;
                }

                const data = await resp.json();

                if (!data.qr_code_base64) {
                    console.error("QR Code n√£o recebido:", data);
                    document.getElementById("loading").textContent = "Erro ao gerar Pix.";
                    return;
                }

                document.getElementById("loading").style.display = "none";
                document.getElementById("qrCode").style.display = "block";
                document.getElementById("qrImg").src = "data:image/png;base64," + data.qr_code_base64;
                document.getElementById("pixCode").value = data.qr_code;

                verificarPagamento(data.id, usuario);

            } catch (err) {
                console.error(err);
                document.getElementById("loading").textContent = "Erro ao gerar Pix.";
            }
        }

        async function verificarPagamento(payment_id, usuario) {
            const interval = setInterval(async () => {
                try {
                    const resp = await fetch(`/api/check-status/${payment_id}`); // <- ajustado para /api
                    const data = await resp.json();

                    if (data.status === "approved") {
                        clearInterval(interval);
                        document.getElementById("status").textContent = "üü© Inscri√ß√£o realizada com sucesso!";

                        await fetch("/api/send-to-sheet", {  // <- ajustado para /api
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(usuario)
                        });

                        localStorage.removeItem('formData');
                    } else {
                        document.getElementById("status").textContent = `Aguardando pagamento... (${data.status})`;
                    }
                } catch (err) {
                    console.error(err);
                    document.getElementById("status").textContent = "Erro ao verificar pagamento.";
                }
            }, 3000);
        }

        document.getElementById("btnCopiar").addEventListener("click", () => {
            const pixCode = document.getElementById("pixCode");
            pixCode.select();
            pixCode.setSelectionRange(0, 99999);
            try {
                document.execCommand("copy");
                alert("Pix copiado para a √°rea de transfer√™ncia!");
            } catch (err) {
                console.error("Erro ao copiar:", err);
            }
        });

        gerarPix();
    </script>
</body>

</html> -->


<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento - RESTART</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/pagamento.css">
</head>

<body>
    <div class="payment-container">
        <h1>Pagamento - Inscri√ß√£o RESTART</h1>

        <p id="aviso">VALOR R$10,00</p>
        <p id="vagas">Carregando vagas...</p>

        <div id="loading" style="display:none;">
            Gerando Pix...
            <div class="spinner"></div>
        </div>

        <div id="qrCode" style="display:none;">
            <img id="qrImg" src="" alt="QR Code">
            <p>C√≥digo Copia e Cola:</p>
            <textarea id="pixCode" rows="3" readonly></textarea>
            <button id="btnCopiar">Copiar Pix</button>
        </div>

        <div id="status"></div>
    </div>

    <script>
        // ===========================
        // üü° Checar vagas dispon√≠veis
        // ===========================
        async function checarVagas() {
            try {
                const resp = await fetch("/api/pagamento/status");
                const data = await resp.json();

                if (data.vagasRestantes <= 0) {
                    document.body.innerHTML = `
            <div class="payment-container">
              <h1>Inscri√ß√µes Esgotadas</h1>
              <p style="color:red; font-size:1.3em;">
                Inscri√ß√µes para o primeiro lote esgotadas.
              </p>
            </div>`;
                    return false;
                }

                document.getElementById("vagas").textContent =
                    "Vagas dispon√≠veis: " + data.vagasRestantes;
                return true;

            } catch (err) {
                console.error("Erro ao checar vagas:", err);
                document.getElementById("vagas").textContent = "Erro ao carregar vagas.";
                return false;
            }
        }

        // ===========================
        // üü¢ Gerar PIX
        // ===========================
        async function gerarPix() {
            const formData = localStorage.getItem('formData');
            const usuario = formData ? JSON.parse(formData) : null;

            if (!usuario || !usuario.nome || !usuario.email || !usuario.cpf) {
                alert("Erro: dados do formul√°rio n√£o encontrados. Volte e preencha novamente.");
                document.getElementById("loading").textContent = "Erro: dados n√£o encontrados.";
                document.getElementById("loading").style.display = "block";
                return;
            }

            document.getElementById("loading").style.display = "block";

            try {
                const resp = await fetch("/api/pagamento/generate-pix", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(usuario)
                });

                if (resp.status === 403) {
                    const data = await resp.json();
                    document.body.innerHTML = `
            <div class="payment-container">
              <h1>Inscri√ß√µes Esgotadas</h1>
              <p style="color:red; font-size:1.3em;">${data.error}</p>
            </div>`;
                    return;
                }

                if (!resp.ok) {
                    const errorData = await resp.json().catch(() => ({}));
                    console.error("Erro Mercado Pago:", errorData);
                    document.getElementById("loading").textContent = "Erro ao gerar Pix.";
                    return;
                }

                const data = await resp.json();

                if (!data.qr_code_base64) {
                    console.error("QR Code n√£o recebido:", data);
                    document.getElementById("loading").textContent = "Erro ao gerar Pix.";
                    return;
                }

                document.getElementById("loading").style.display = "none";
                document.getElementById("qrCode").style.display = "block";
                document.getElementById("qrImg").src = "data:image/png;base64," + data.qr_code_base64;
                document.getElementById("pixCode").value = data.qr_code;

                verificarPagamento(data.id, usuario);

            } catch (err) {
                console.error(err);
                document.getElementById("loading").textContent = "Erro ao gerar Pix.";
            }
        }

        // ===========================
        // üü£ Verificar status do pagamento
        // ===========================
        async function verificarPagamento(payment_id, usuario) {
            const interval = setInterval(async () => {
                try {
                    const resp = await fetch("/api/pagamento/check-status/" + payment_id);
                    const data = await resp.json();

                    if (data.status === "approved") {
                        clearInterval(interval);
                        document.getElementById("status").textContent = "üü© Inscri√ß√£o realizada com sucesso!";

                        await fetch("/api/pagamento/send-to-sheet", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(usuario)
                        });

                        localStorage.removeItem('formData');
                        checarVagas();
                    } else {
                        document.getElementById("status").textContent =
                            "Aguardando pagamento... (" + data.status + ")";
                    }
                } catch (err) {
                    console.error(err);
                    document.getElementById("status").textContent = "Erro ao verificar pagamento.";
                }
            }, 3000);
        }

        // ===========================
        // üìã Copiar c√≥digo Pix
        // ===========================
        document.getElementById("btnCopiar").addEventListener("click", () => {
            const pixCode = document.getElementById("pixCode");
            pixCode.select();
            pixCode.setSelectionRange(0, 99999);
            try {
                document.execCommand("copy");
                alert("Pix copiado para a √°rea de transfer√™ncia!");
            } catch (err) {
                console.error("Erro ao copiar:", err);
            }
        });

        // ===========================
        // üöÄ In√≠cio da p√°gina
        // ===========================
        (async () => {
            const podeContinuar = await checarVagas();
            if (podeContinuar) gerarPix();
        })();
    </script>
</body>

</html>